<div class="container mt-5 flashy-form">
  <div
    class="bg-light rounded shadow p-4 border border-2 border-primary-subtle animated-border"
  >
    <div class="d-flex align-items-center mb-4">
      <i class="bi bi-clipboard2-check text-primary fs-3 me-2 neon-icon"></i>
      <h3 class="m-0">
        {{ isNew ? "Nueva Designación" : "Editar Designación" }}
      </h3>
    </div>

    <form #designacionForm="ngForm" (ngSubmit)="saveDesignacion()">
      <div class="row g-4">
        <!-- Selección de Persona -->
        <div class="col-md-6">
          <label for="persona" class="form-label required-field">
            <i class="bi bi-person-fill text-primary me-1"></i>
            Persona
          </label>
          <select
            class="form-select enhanced-select"
            [ngClass]="{
              'is-invalid':
                personaField.invalid &&
                (personaField.dirty || personaField.touched)
            }"
            [(ngModel)]="designacion.persona"
            [compareWith]="comparePersonas"
            name="persona"
            #personaField="ngModel"
            required
          >
            <option [ngValue]="null">Seleccione una persona</option>
            <option *ngFor="let persona of personas" [ngValue]="persona">
              {{ persona.apellido }}, {{ persona.nombre }} ({{ persona.dni }})
            </option>
          </select>

          <!-- Preview e información de la persona seleccionada -->
          <div *ngIf="designacion.persona" class="d-flex flex-wrap gap-2 mt-2">
            <div>
              <span class="badge bg-info text-dark fs-6">
                <i class="bi bi-person-fill me-1"></i>
                {{ designacion.persona.apellido }},
                {{ designacion.persona.nombre }}
              </span>
            </div>

            <div>
              <span class="badge bg-info text-dark fs-6">
                <i class="bi bi-card-text me-1"></i>
                {{ designacion.persona.dni }}
              </span>
            </div>

            <div>
              <span class="badge bg-info text-dark fs-6">
                <i class="bi bi-telephone-fill me-1"></i>
                {{ designacion.persona.telefono }}
              </span>
            </div>

            <div>
              <span
                *ngIf="designacion.persona.titulo"
                class="badge bg-info text-dark fs-6"
              >
                <i class="bi bi-mortarboard-fill me-1"></i>
                {{ designacion.persona.titulo }}
              </span>
            </div>
          </div>

          <div class="mt-1">
            <small
              class="error-message"
              *ngIf="
                personaField.invalid &&
                (personaField.dirty || personaField.touched)
              "
            >
              Debe seleccionar una persona
            </small>
          </div>
        </div>

        <!-- Selección de Cargo -->
        <div class="col-md-6">
          <label for="cargo" class="form-label required-field">
            <i class="bi bi-briefcase-fill text-primary me-1"></i>
            Cargo
          </label>
          <select
            class="form-select enhanced-select"
            [ngClass]="{
              'is-invalid':
                cargoField.invalid && (cargoField.dirty || cargoField.touched)
            }"
            [(ngModel)]="designacion.cargo"
            [compareWith]="compareCargos"
            name="cargo"
            #cargoField="ngModel"
            required
          >
            <option [ngValue]="null">Seleccione un cargo</option>
            <option *ngFor="let cargo of cargos" [ngValue]="cargo">
              {{ cargo.nombre }}
              <span *ngIf="cargo.division">
                ({{ cargo.division.anio }}° {{ cargo.division.numDivision }}º -
                {{ cargo.division.orientacion }})
              </span>
              <span *ngIf="!cargo.division">(Cargo Institucional)</span>
            </option>
          </select>

          <!-- Preview del cargo -->
          <div class="d-flex flex-wrap gap-2 mt-2" *ngIf="designacion.cargo">
            <span class="badge bg-info text-white fs-6">
              <i
                class="me-1"
                [ngClass]="{
                  'bi bi-building-fill': isCargoInstitucional(),
                  'bi bi-book-fill': !isCargoInstitucional()
                }"
              ></i>
              {{ designacion.cargo.nombre }}
            </span>

            <span class="badge bg-info text-white fs-6">
              <i class="bi bi-clock-fill me-1"></i>
              Carga horaria: {{ designacion.cargo.cargaHoraria }} hs
            </span>
          </div>

          <div class="mt-1">
            <small
              class="error-message"
              *ngIf="
                cargoField.invalid && (cargoField.dirty || cargoField.touched)
              "
            >
              Debe seleccionar un cargo
            </small>
          </div>
        </div>

        <!-- Situación de Revista -->
        <div class="col-md-4">
          <label for="situacionRevista" class="form-label required-field">
            <i class="bi bi-clipboard-check text-primary me-1"></i>
            Situación de Revista
          </label>
          <select
            class="form-select enhanced-select"
            [ngClass]="{
              'is-invalid':
                situacionField.invalid &&
                (situacionField.dirty || situacionField.touched)
            }"
            [(ngModel)]="designacion.situacionRevista"
            name="situacionRevista"
            #situacionField="ngModel"
            required
          >
            <option [ngValue]="null">Seleccione una situación</option>
            <option
              *ngFor="let situacion of situacionesRevista"
              [value]="situacion"
            >
              {{ situacion }}
            </option>
          </select>

          <!-- Preview de situación de revista -->
          <div class="mt-2" *ngIf="designacion.situacionRevista">
            <span class="badge bg-info text-dark fs-6">
              <i class="bi bi-clipboard-check me-1"></i>
              {{ designacion.situacionRevista }}
            </span>
          </div>

          <div class="mt-1">
            <small
              class="error-message"
              *ngIf="
                situacionField.invalid &&
                (situacionField.dirty || situacionField.touched)
              "
            >
              Debe seleccionar una situación
            </small>
          </div>
        </div>

        <!-- Fecha de Inicio -->
        <div class="col-md-4">
          <label for="fechaInicio" class="form-label required-field">
            <i class="bi bi-calendar-check text-primary me-1"></i>
            Fecha de Inicio
          </label>
          <input
            type="date"
            class="form-control enhanced-input"
            [ngClass]="{
              'is-invalid':
                fechaInicioField.invalid &&
                (fechaInicioField.dirty || fechaInicioField.touched)
            }"
            [(ngModel)]="designacion.fechaInicio"
            name="fechaInicio"
            #fechaInicioField="ngModel"
            [max]="maxFechaInicio || '9999-12-31'"
            (change)="onFechaInicioChange()"
            required
          />

          <!-- Preview de fecha de inicio -->
          <div class="mt-2" *ngIf="designacion.fechaInicio">
            <span class="badge bg-info fs-6">
              <i class="bi bi-calendar-check me-1"></i>
              {{ designacion.fechaInicio | date : "dd/MM/yyyy" }}
            </span>
          </div>

          <div class="mt-1">
            <small
              class="error-message"
              *ngIf="
                fechaInicioField.invalid &&
                (fechaInicioField.dirty || fechaInicioField.touched)
              "
            >
              La fecha de inicio es obligatoria
            </small>
          </div>
        </div>

        <!-- Fecha de Fin (opcional) -->
        <div class="col-md-4">
          <label for="fechaFin" class="form-label">
            <i class="bi bi-calendar-x text-primary me-1"></i>
            Fecha de Fin
          </label>
          <input
            type="date"
            class="form-control enhanced-input"
            [(ngModel)]="designacion.fechaFin"
            name="fechaFin"
            [min]="minFechaFin"
            (change)="onFechaFinChange()"
          />

          <!-- Preview de fecha de fin -->
          <div class="mt-2">
            <span
              class="badge bg-info text-dark fs-6"
              *ngIf="designacion.fechaFin"
            >
              <i class="bi bi-calendar-x me-1"></i>
              {{ designacion.fechaFin | date : "dd/MM/yyyy" }}
            </span>
            <span class="badge bg-success fs-6" *ngIf="!designacion.fechaFin">
              <i class="bi bi-infinity me-1"></i>
              Vigente
            </span>
          </div>

          <div class="mt-1">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Este campo es opcional (designación vigente)
            </small>
          </div>
        </div>
      </div>

      <!-- Sección de resumen mejorada y alineada -->
      <div
        class="row mt-4"
        *ngIf="
          designacion.persona ||
          designacion.cargo ||
          designacion.situacionRevista
        "
      >
        <div class="col-12">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white">
              <h6 class="mb-0">
                <i class="bi bi-eye-fill me-2"></i>
                Vista previa de la designación
              </h6>
            </div>
            <div class="card-body">
              <div class="row align-items-start">
                <!-- Columna izquierda -->
                <div class="col-md-6">
                  <!-- Persona -->
                  <div class="mb-3" *ngIf="designacion.persona">
                    <div class="d-flex align-items-center mb-1">
                      <i class="bi bi-person-fill text-primary me-2"></i>
                      <strong>Persona:</strong>
                    </div>
                    <div class="ms-4">
                      <span class="fw-bold">
                        {{ designacion.persona.apellido }},
                        {{ designacion.persona.nombre }}
                      </span>
                      <br />
                      <small class="text-muted">
                        <i class="bi bi-card-text me-1"></i>
                        DNI: {{ designacion.persona.dni }}
                      </small>
                    </div>
                  </div>

                  <!-- Cargo -->
                  <div class="mb-3" *ngIf="designacion.cargo">
                    <div class="d-flex align-items-center mb-1">
                      <i
                        class="text-success me-2"
                        [ngClass]="{
                          'bi bi-building-fill': isCargoInstitucional(),
                          'bi bi-book-fill': !isCargoInstitucional()
                        }"
                      ></i>
                      <strong>Cargo:</strong>
                    </div>
                    <div class="ms-4">
                      <span class="text-primary fw-semibold">{{
                        designacion.cargo.nombre
                      }}</span>
                      <br />
                      <small class="text-muted">
                        <i class="bi bi-clock-fill me-1"></i>
                        {{ designacion.cargo.cargaHoraria }} hs -
                        {{
                          isCargoInstitucional()
                            ? "Cargo Institucional"
                            : "Espacio Curricular"
                        }}
                      </small>
                    </div>
                  </div>
                </div>

                <!-- Columna derecha -->
                <div class="col-md-6">
                  <!-- División -->
                  <div
                    class="mb-3"
                    *ngIf="designacion.cargo && designacion.cargo.division"
                  >
                    <div class="d-flex align-items-center mb-1">
                      <i class="bi bi-mortarboard-fill text-primary me-2"></i>
                      <strong>División:</strong>
                    </div>
                    <div class="ms-4">
                      <span class="fw-bold">
                        {{ designacion.cargo.division.anio }}°
                        {{ designacion.cargo.division.numDivision }}º
                      </span>
                      <span class="badge bg-warning text-dark ms-2">
                        {{ designacion.cargo.division.turno }}
                      </span>
                      <br />
                      <small
                        class="text-muted"
                        *ngIf="designacion.cargo.division.orientacion"
                      >
                        <i class="bi bi-compass me-1"></i>
                        {{ designacion.cargo.division.orientacion }}
                      </small>
                    </div>
                  </div>

                  <!-- Situación y Vigencia -->
                  <div class="mb-3">
                    <div
                      class="d-flex align-items-center mb-1"
                      *ngIf="designacion.situacionRevista"
                    >
                      <i class="bi bi-clipboard-check text-info me-2"></i>
                      <strong>Situación:</strong>
                    </div>
                    <div class="ms-4" *ngIf="designacion.situacionRevista">
                      <span class="badge bg-info text-dark">
                        {{ designacion.situacionRevista }}
                      </span>
                    </div>

                    <div
                      class="d-flex align-items-center mb-1 mt-2"
                      *ngIf="designacion.fechaInicio"
                    >
                      <i class="bi bi-calendar-check text-success me-2"></i>
                      <strong>Vigencia:</strong>
                    </div>
                    <div class="ms-4" *ngIf="designacion.fechaInicio">
                      <span class="text-muted">
                        {{ designacion.fechaInicio | date : "dd/MM/yyyy" }}
                        <span *ngIf="designacion.fechaFin">
                          - {{ designacion.fechaFin | date : "dd/MM/yyyy" }}
                        </span>
                        <span
                          *ngIf="!designacion.fechaFin"
                          class="text-success fw-bold ms-1"
                        >
                          (Vigente)
                        </span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="mt-4 d-flex justify-content-between align-items-center">
        <button
          type="button"
          class="btn btn-outline-secondary px-4"
          (click)="volver()"
        >
          <i class="bi bi-arrow-left me-2"></i>
          Volver a la lista
        </button>
        <button
          type="submit"
          class="btn btn-outline-primary px-4"
          [disabled]="designacionForm.invalid || !isValidDateRange"
        >
          <i class="bi bi-check-circle me-2"></i>
          {{ isNew ? "Crear Designación" : "Guardar Cambios" }}
        </button>
      </div>

      <!-- Mensaje de éxito o error -->
      <div
        *ngIf="mensaje"
        id="message-container"
        class="alert mt-4"
        [ngClass]="{ 'alert-danger': isError, 'alert-success': !isError }"
        role="alert"
      >
        <div class="d-flex justify-content-between align-items-center">
          <span>{{ mensaje }}</span>
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            (click)="volver()"
          >
            <i class="bi bi-arrow-left me-1"></i>Volver
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
